# Добавление контента (инструкция для пользователя)

Omoide оптимизирована для просмотра, но за это приходится платить несколько
неудобной загрузкой данных в систему. Эта операция происходит редко и требует
серьёзных манипуляций с привлечением системного администратора. Но сама
подготовка данных для загрузки технически не очень сложна и может выполняться
любым пользователем.

1. [Базовая структура каталогов](#Базовая-структура-каталогов)
2. [Правила именования](#Правила-именования)
3. [Алгоритм добавления данных](#Алгоритм-добавления-данных)
4. [Работа с source.json](#Работа-с-source.json)
    - [Сущности](#Сущности)
    - [Генерация идентификаторов](#Генерация-идентификаторов)
    - [Полезные советы](#Полезные-советы)

## Базовая структура каталогов

Внутреннее хранение данных в Omoide построено вокруг каталогов с файлами
внутри. Это позволяет добавлять их без применения специальных инструментов.
Изначально такая схема была выбрана, чтобы сохранить возможность просматривать
содержимое даже если у вас нет возможности запустить сервер приложения, а
просто откуда-то появилась папка с исходным материалом.

Эталонная структура каталога исходных данных:

```
sources/
└── source_1/
    └── migration_1/
        ├── cats/
        │   └── fat_cats
        │       ├── cat1.jpg
        │       └── cat2.jpg
        └── source.json
```

Все материалы хранятся в папке **sources**, внутри которой находятся одна или
несколько корневых папок с исходными данными (в данном случае **source_1**). В
каждой такой папке находятся одна или несколько папок уже с конкретным
содержимым внутри (в данном случае **migration_1**). Уровень вложенности должен
быть именно таким, не больше и не меньше. В финальной папке должен быть файл
**source.json** с описанием того, что вы собираетесь загрузить и набором папок
с конкретными картинками внутри.

Имена используемых каталогов верхнего уровня не имеют значения, эти имена нигде
не будут использоваться и нужны просто для удобства человека, который будет
добавлять материал. Верхний уровень подходит для тем контента (cats, frogs), а
нижний для группировки по смыслу (summer_cats, autumn_cats).

## Правила именования

Для упрощения обработки, к файлам и каталогам предъявляются очень жёсткие
требования по именованию. Допускаются только маленькие буквы английского
алфавита, цифры и знак подчёркивания. Никаких восклицательных знаков,
вопросительных знаков, тире и тому подобного. То же самое касается тегов.
Места, в которых можно писать что угодно будут отмечены особо.

## Алгоритм добавления данных

- Если уже есть подходящие по смыслу каталоги, достаточно поместить в них
  имеющиеся картинки (см. ниже) и добавить описание в существующий source.json.
- Если есть подходящий каталог верхнего уровня, но нет нижнего - надо создать
  его, переместить данные и создать source.json.
- Если вообще ничего подходящего нет, то создать надо всю цепочку целиком.

## Работа с source.json

Если раньше вы не работали с JSON файлами, вы можете
прочитать [краткую справку по этому формату](./json.md).

**source.json** это основной способ добавления данных в omoide, через него вы
описываете системе, как работать с данными, которые вы предоставили.

Ожидается, что в файле будет набор записей, которые должны быть запущены в
обработку. В качестве ключа указывается категория, а затем последовательность
из элементов, которые надо добавить.

Например:

```json
{
    "themes": [],
    "groups": [],
    "metas": [],
    "synonyms": []
}
```

Можно не указывать любые из ключей, можно вообще оставить только {}.

### Сущности

Исходные файлы omoide оперируют следующими видами сущностей:

- Тема (theme): коллекция схожих по смыслу записей.
- Группа (group): коллекция картинок в рамках одного пакета, например один
  альбом или один артбук.
- Запись (meta): одна картинка.
- Синоним (synonym): специальный элемент, помогающий в поиске.

#### Theme

Тема объединяет группы схожие по смыслу. Например "cats". Темы могут
использоваться при фильтрации, можно ограничить список интересующих вас тем и
искать только в нескольких конкретных.

Простейший вариант создания темы про кошек:

```json
{
    "themes": [
        {
            "uuid": "var('t', 'theme_cats')",
            "route": "cats",
            "label": "Cats theme"
        }
    ]
}
```

Смысл конструкции "var('t', 'theme_cats')" описывается в
разделе [Генерация идентификаторов](#Генерация-идентификаторов).

Расширенный вариант создания темы про кошек:

```json
{
    "themes": [
        {
            "uuid": "var('t', 'theme_cats')",
            "route": "cats",
            "label": "Cats theme",
            "tags": [
                "cat",
                "cats"
            ]
        }
    ]
}
```

Значения полей:

- uuid: уникальный идентификатор темы (генерируется автоматически).
- route: имя каталога, в котором лежат соответствующие группы.
- label: название темы, которые будет отображаться на сайте. Здесь можно
  использовать любые символы.
- tags (можно не указывать): теги, которые будут присвоены теме. Они также
  будут присвоены всем группам в этой теме и всем записям в этой теме.

Вот пример из начала страницы:

```
sources/
└── source_1/
    └── migration_1/
        ├── cats/
        │   └── fat_cats
        │       ├── cat1.jpg
        │       └── cat2.jpg
        └── source.json
```

В каталоге migration_1 есть папка cats соответствующая теме "Cats theme".
Внутри неё находится одна или несколько папок для групп внутри этой темы.

#### Group

Набор конкретных картинок, например одна фотосессия, один артбук или один
комплект обложек. По группам нельзя фильтроваться так же как по темам, но их
можно искать и в результате поиск будет выдавать только картинки в этой группе.

Простейший вариант создания группы про толстых кошек:

```json
{
    "groups": [
        {
            "uuid": "var('g', 'group_fat_cats')",
            "theme_uuid": "$theme_cats",
            "route": "fat_cats",
            "label": "Fat cats"
        }
    ]
}
```

Значения полей:

- uuid: уникальный идентификатор группы (генерируется автоматически).
- theme_uuid: уникальный идентификатор темы, к которой относится эта группа (
  требуется указать существующий).
- route: имя каталога, в котором лежат соответствующие картинки.
- label: название группы, которые будет отображаться на сайте. Здесь можно
  использовать любые символы.

#### Meta

TODO

#### Synonym

TODO

### Генерация идентификаторов

TODO

### Полезные советы

TODO
